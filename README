# ü§ñ Agent OCR et Comparaison

Agent intelligent pour l'analyse automatis√©e des bulletins scolaires via OCR et la comparaison avec les notes saisies manuellement par les candidats.


## üéØ Objectifs

Cet agent permet de :
- **üìÑ Analyser automatiquement** les bulletins scolaires PDF
- **üîç Extraire les notes** via OCR (GPT-4o Vision)
- **‚öñÔ∏è Comparer intelligemment** les notes OCR avec les notes saisies manuellement
- **üö® D√©tecter les anomalies** et incoh√©rences
- **üìä G√©n√©rer des rapports** d√©taill√©s de validation
- **‚úÖ Recommander** la validation ou le rejet automatiquement

## üèóÔ∏è Architecture

```
agent_OCR_Comparaison/
‚îú‚îÄ‚îÄ __init__.py                    # Package principal et exports
‚îú‚îÄ‚îÄ models.py                      # Mod√®les Pydantic (notes, bulletins, r√©sultats)
‚îú‚îÄ‚îÄ utils_candidature.py           # Utilitaires pour candidatures
‚îú‚îÄ‚îÄ workflow_ocr_comparaison.py    # Workflow principal LangGraph
‚îú‚îÄ‚îÄ charger_bulletins.py           # Chargement et validation des PDF
‚îú‚îÄ‚îÄ extraction_notes_ocr.py        # Extraction OCR avec GPT-4o Vision
‚îú‚îÄ‚îÄ comparaison_notes.py           # Comparaison intelligente et d√©tection d'anomalies
‚îú‚îÄ‚îÄ rapport_comparaison.py         # G√©n√©ration de rapports (TXT, JSON, CSV, PDF)
‚îú‚îÄ‚îÄ concordance_checker.py         # V√©rification de concordance globale
‚îú‚îÄ‚îÄ integration_admin.py           # Int√©gration avec l'admin existant
‚îî‚îÄ‚îÄ tests/
    ‚îú‚îÄ‚îÄ __init__.py
    ‚îî‚îÄ‚îÄ test_agent_ocr.py          # Tests unitaires complets
```

## üöÄ Installation

### Pr√©requis

- Python 3.8+
- Cl√© API OpenAI (pour GPT-4o Vision)
- Modules admin existants (admin_utils, admin_config, etc.)

### Installation des d√©pendances

```bash
# Installation des d√©pendances principales
pip install -r requirements.txt

# Ou installation manuelle
pip install pydantic>=2.0.0 langgraph>=0.1.0 openai>=1.0.0 python-dotenv>=1.0.0
pip install PyMuPDF>=1.23.0 reportlab>=4.0.0 pandas>=2.0.0 streamlit>=1.28.0
```

### Configuration

1. **Cr√©er un fichier `.env`** dans le dossier racine :
```env
OPENAI_API_KEY=votre_cle_api_openai_ici
```

2. **V√©rifier l'installation** :
```python
from agent_OCR_Comparaison import valider_environnement
print(valider_environnement())
```

## üìñ Utilisation

### Utilisation simple

```python
from agent_OCR_Comparaison import analyser_candidature_simple, NoteManuelle, ConfigurationOCR

# Configuration
config = ConfigurationOCR(
    moteur_ocr="gpt-4o",
    seuil_confiance_ocr=0.7,
    tolerance_ecart_notes=1.0
)

# Notes saisies par le candidat
notes_manuelles = [
    NoteManuelle(matiere="Math√©matiques", note=15.5, coefficient=3),
    NoteManuelle(matiere="Fran√ßais", note=14.0, coefficient=3),
    NoteManuelle(matiere="Histoire-G√©ographie", note=16.0, coefficient=2),
]

# Analyse de la candidature
resultat = analyser_candidature_simple(
    dossier_candidature="/path/to/candidature/DUPONT_Jean_20241201/",
    notes_manuelles=notes_manuelles,
    config=config
)

# R√©sultats
if resultat.resultat_comparaison:
    comp = resultat.resultat_comparaison
    print(f"Recommandation: {comp.recommandation_validation}")
    print(f"Score confiance: {comp.score_confiance_final:.1%}")
    print(f"Correspondances: {comp.correspondances_trouvees}/{comp.total_notes_manuelles}")
    print(f"Anomalies: {len(comp.anomalies)}")
```

### Utilisation avanc√©e avec workflow

```python
from agent_OCR_Comparaison import WorkflowOCRComparaison, ConfigurationOCR

# Configuration avanc√©e
config = ConfigurationOCR(
    moteur_ocr="gpt-4o",
    seuil_confiance_ocr=0.7,
    tolerance_ecart_notes=1.0,
    score_confiance_minimum=0.8,
    max_anomalies_critiques=0,
    max_anomalies_elevees=2,
    generer_rapport_pdf=True,
    debug_mode=False
)

# Cr√©er le workflow
workflow = WorkflowOCRComparaison(config)

# Analyser une candidature compl√®te
resultat = workflow.analyser_candidature(
    dossier_candidature="/path/to/candidature/",
    notes_manuelles=notes_manuelles,
    candidat_nom="Dupont",
    candidat_prenom="Jean",
    reference_candidature="CAND2024001"
)

# R√©sultats d√©taill√©s
print(f"Statut workflow: {resultat.workflow_status}")
print(f"Dur√©e: {resultat.duree_execution:.2f}s")
print(f"Bulletins analys√©s: {len(resultat.bulletins_info)}")

if resultat.erreurs_rencontrees:
    print("Erreurs:", resultat.erreurs_rencontrees)
```

### Int√©gration avec l'admin existant

```python
# Dans admin_components.py
from agent_OCR_Comparaison.integration_admin import render_section_ocr_avancee

def render_candidature_details(candidature):
    # ... code existant ...
    
    # Ajouter la section OCR avanc√©e
    render_section_ocr_avancee(candidature)
```

## üîß Configuration

### Param√®tres principaux

| Param√®tre | Type | D√©faut | Description |
|-----------|------|--------|-------------|
| `moteur_ocr` | str | "gpt-4o" | Moteur OCR √† utiliser |
| `seuil_confiance_ocr` | float | 0.7 | Seuil de confiance minimum OCR |
| `tolerance_ecart_notes` | float | 1.0 | Tol√©rance d'√©cart en points |
| `score_confiance_minimum` | float | 0.8 | Score minimum validation auto |
| `max_anomalies_critiques` | int | 0 | Nombre max d'anomalies critiques |
| `generer_rapport_pdf` | bool | True | G√©n√©rer des rapports PDF |

### Configuration avanc√©e

```python
config = ConfigurationOCR(
    # OCR
    moteur_ocr="gpt-4o",
    seuil_confiance_ocr=0.7,
    resolution_images=300,
    
    # Comparaison
    tolerance_ecart_notes=1.0,
    seuil_similarite_matieres=0.7,
    
    # Validation
    score_confiance_minimum=0.8,
    max_anomalies_critiques=0,
    max_anomalies_elevees=2,
    
    # Options
    debug_mode=False,
    sauvegarder_images_temp=False,
    generer_rapport_pdf=True
)
```

## üìä Formats de sortie

### R√©sultat de comparaison

```python
resultat.resultat_comparaison:
    - correspondances_trouvees: int
    - taux_correspondance: float
    - confiance_globale: float
    - recommandation_validation: str
    - score_confiance_final: float
    - anomalies: List[AnomalieDetectee]
    - comparaisons: List[ComparaisonNote]
```

### Recommandations possibles

- `VALIDATION_AUTOMATIQUE_RECOMMANDEE` : ‚úÖ Validation automatique possible
- `VERIFICATION_MANUELLE_LEGERE` : ‚ö†Ô∏è V√©rification rapide recommand√©e
- `VERIFICATION_MANUELLE_APPROFONDIE` : üîç V√©rification d√©taill√©e n√©cessaire
- `REJET_RECOMMANDE` : ‚ùå Rejet ou documents suppl√©mentaires requis

### Rapports g√©n√©r√©s

- **TXT** : Rapport d√©taill√© lisible
- **JSON** : Donn√©es structur√©es pour traitement automatique
- **CSV** : Comparaisons pour analyse statistique
- **PDF** : Rapport professionnel avec graphiques

## üö® Types d'anomalies d√©tect√©es

| Type | S√©v√©rit√© | Description |
|------|----------|-------------|
| `ECART_NOTE_MAJEUR` | üî¥ Critique | √âcart >2 points entre OCR et manuel |
| `NOTE_MANQUANTE_OCR` | üü° Moyenne | Note saisie non trouv√©e dans OCR |
| `NOTE_SUPPLEMENTAIRE_OCR` | üü¢ Faible | Note OCR non saisie manuellement |
| `CONFIANCE_OCR_FAIBLE` | üü° Moyenne | Extraction OCR peu fiable |
| `MOYENNE_INCOHERENTE` | üî¥ √âlev√©e | Moyennes globales tr√®s diff√©rentes |

## üõ†Ô∏è D√©veloppement

### Structure du code

```python
# Mod√®les de donn√©es (models.py)
@dataclass
class NoteManuelle:
    matiere: str
    note: float
    coefficient: int

# Workflow principal (workflow_ocr_comparaison.py)
class WorkflowOCRComparaison:
    def analyser_candidature(self, ...):
        # Workflow LangGraph complet

# Comparaison (comparaison_notes.py)
class ComparateurNotes:
    def comparer_notes(self, ...):
        # Algorithmes de comparaison et d√©tection d'anomalies
```

### Extensibilit√©

- **Nouveaux moteurs OCR** : Ajouter dans `extraction_notes_ocr.py`
- **Nouvelles anomalies** : √âtendre `SeveriteAnomalie` et `AnomalieDetectee`
- **Nouveaux formats** : Ajouter dans `rapport_comparaison.py`
- **Nouvelles validations** : √âtendre `concordance_checker.py`

### Contribution

1. Fork le projet
2. Cr√©er une branche feature (`git checkout -b feature/nouvelle-fonctionnalite`)
3. Ajouter des tests pour la nouvelle fonctionnalit√©
4. Committer les changements (`git commit -am 'Ajout nouvelle fonctionnalit√©'`)
5. Pousser vers la branche (`git push origin feature/nouvelle-fonctionnalite`)
6. Cr√©er une Pull Request

## üêõ Probl√®mes courants

### Erreur "OpenAI API non configur√©e"

```bash
# Solution : Cr√©er le fichier .env
echo "OPENAI_API_KEY=votre_cle" > .env
```

### Erreur "Module non trouv√©"

```bash
# Solution : Installer les d√©pendances
pip install -r requirements.txt
```

### OCR peu pr√©cis

- V√©rifier la qualit√© des PDFs source
- Augmenter la r√©solution (`resolution_images=600`)
- Utiliser le pr√©traitement d'images
- Ajuster le seuil de confiance

### Faux positifs dans les anomalies

- Ajuster `tolerance_ecart_notes`
- Modifier `seuil_similarite_matieres`
- Personnaliser les patterns de mati√®res

## üìö R√©f√©rences

- [Documentation OpenAI GPT-4o Vision](https://platform.openai.com/docs/guides/vision)
- [LangGraph Documentation](https://langchain-ai.github.io/langgraph/)
- [Pydantic Documentation](https://docs.pydantic.dev/)
- [PyMuPDF Documentation](https://pymupdf.readthedocs.io/)
- [ReportLab Documentation](https://docs.reportlab.com/)

## üìÑ Licence

Ce projet est sous licence MIT. Voir le fichier [LICENSE](LICENSE) pour plus de d√©tails.

## üë• √âquipe

D√©velopp√© par l'√©quipe du syst√®me d'administration des candidatures.

## üÜï Changelog

### v2.0.0 (Actuel)
- ‚ú® Extraction OCR avec GPT-4o Vision
- ‚ú® Workflow LangGraph complet
- ‚ú® Comparaison intelligente avec d√©tection d'anomalies
- ‚ú® Rapports multi-formats (TXT, JSON, CSV, PDF)
- ‚ú® Int√©gration avec l'admin existant
- ‚ú® Tests unitaires complets
- ‚ú® Documentation compl√®te

### v1.0.0 (Baseline)
- ‚ú® Prototype initial avec OCR basique
- ‚ú® Comparaison simple
- ‚ú® Rapports texte uniquement

---

üéØ **Pour toute question ou support**, contactez l'√©quipe de d√©veloppement ou consultez la documentation int√©gr√©e avec `help(agent_OCR_Comparaison)`.